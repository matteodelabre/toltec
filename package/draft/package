# vim: set ft=sh:
pkgname=draft
pkgdesc="Launcher which wraps around the standard interface"
url=https://github.com/dixonary/draft-reMarkable
pkgver=0.2.0-13
timestamp=2020-07-20T10:23Z
section=launchers
maintainer="Matt√©o Delabre <spam@delab.re>"
license=Apache-2.0
depends=(xochitl)

image=qt:v1.1
source=(
    https://github.com/dixonary/draft-reMarkable/archive/5bd660a2fd07eba166c6110d2b48cfc58ee67e58.zip
    draft.service
)
sha256sums=(
    c41d7a4fd537c54d787018fd764421dbf7dd64306ca800875283e05eef99173e
    SKIP
)

build() {
    qmake draft.pro
    make
}

package() {
    install -D -m 755 -t "$pkgdir"/opt/bin "$srcdir"/draft

    install -d "$pkgdir"/opt/share/draft "$pkgdir"/usr/share
    ln -s /opt/share/draft "$pkgdir"/usr/share/draft
    cp -r "$srcdir"/qml "$pkgdir"/opt/share/draft
    cp -r "$srcdir"/js "$pkgdir"/opt/share/draft

    install -d "$pkgdir"/opt/etc/draft "$pkgdir"/etc
    ln -s /opt/etc/draft "$pkgdir"/etc/draft
    cp -r "$srcdir"/extra-files/draft/* "$pkgdir"/opt/etc/draft
    rm "$pkgdir"/opt/etc/draft/01-xochitl
    rm "$pkgdir"/opt/etc/draft/icons/xochitl.png
    rm "$pkgdir"/opt/etc/draft/02-fingerterm
    rm "$pkgdir"/opt/etc/draft/icons/fingerterm.png
    mv "$pkgdir"/opt/etc/draft/{99-,}shutdown

    install -D -m 644 -t "$pkgdir"/lib/systemd/system "$srcdir"/draft.service
}

# Check whether a systemd unit exists and is enabled
#
# Arguments:
#
# $1 - Full name of the systemd unit, e.g. "xochitl.service"
#
# Exit code:
#
# 0 if the unit exists and is enabled, 1 otherwise
is-enabled() {
    # Note that we must invert the condition so that the exit code indicates
    # a failure when the unit exists and is disabled or when the unit does
    # not exist
    ! systemctl list-unit-files "$1" | awk "/$1/{exit \$2 == \"enabled\"}"
}

# Get a list of systemd units with which the given unit conflicts
#
# Arguments:
#
# $1 - Full name of the systemd unit, e.g. "xochitl.service"
#
# Output:
#
# List of conflicting units
get-conflicts() {
    systemctl show "$1" | awk -F'=' '/^Conflicts=/{print $2}'
}

configure() {
    systemctl daemon-reload

    if ! is-enabled "$pkgname.service"; then
        echo ""
        echo "Run the following command(s) to use $pkgname as your launcher"

        for conflict in $(get-conflicts "$pkgname.service"); do
            if is-enabled "$conflict"; then
                echo "$ systemctl disable --now ${conflict/.service/}"
            fi
        done

        echo "$ systemctl enable --now $pkgname"
        echo ""
    fi
}

preremove() {
    echo "Disabling $pkgname"
    systemctl disable --now "$pkgname"
}

postremove() {
    systemctl daemon-reload
}
